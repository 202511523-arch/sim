<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMVEX - Tectonic Plates</title>
    <link rel="stylesheet" href="../css/workspace-new.css">
    <link rel="stylesheet" href="style.css?v=3.0">
    <link rel="stylesheet" href="../css/popup-panels.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        .left-sidebar {
            position: fixed;
            top: 84px;
            left: 24px;
            width: 340px;
            max-height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
            z-index: 100;
            overflow: hidden;
        }

        .panel-body-scroll {
            overflow-y: auto;
            padding: 24px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-size: 11px;
            color: var(--accent);
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 0.1em;
        }

        .model-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .model-card {
            padding: 16px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--panel-border);
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .model-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .model-card.active {
            background: rgba(0, 240, 255, 0.1);
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.1);
        }

        .model-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .model-card-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .model-card-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: rgba(0, 240, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 18px;
        }

        .model-container {
            position: fixed;
            top: 84px;
            right: 24px;
            width: calc(100% - 388px - 48px);
            height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
            z-index: 50;
            padding: 24px;
            gap: 12px;
        }

        .model-viewer {
            flex: 1;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--panel-border);
            overflow: hidden;
            display: none;
            position: relative;
        }

        .model-viewer.active {
            display: flex;
            flex-direction: column;
        }

        /* Hide Sketchfab top UI (title, author, icons) */
        .model-viewer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(to bottom, #0a0f18 0%, #0a0f18 70%, transparent 100%);
            pointer-events: none;
            z-index: 200;
            border-radius: 12px 12px 0 0;
        }

        /* Hide Sketchfab bottom UI (help, settings, VR buttons) */
        .model-viewer::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(to top, #0a0f18 0%, #0a0f18 70%, transparent 100%);
            pointer-events: none;
            z-index: 200;
            border-radius: 0 0 12px 12px;
        }

        .model-viewer iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        .sketchfab-embed-wrapper {
            width: 100% !important;
            height: 100% !important;
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
            overflow: hidden;
            border-radius: 12px;
            background: #000000;
        }

        .sketchfab-embed-wrapper p {
            display: none !important;
        }

        .sketchfab-embed-wrapper iframe {
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        .model-info-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--panel-border);
            border-radius: 10px;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .model-info-panel.active {
            display: block;
        }

        .info-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .info-content {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .info-content strong {
            color: #fff;
            display: block;
            margin-top: 8px;
        }

        /* Central Info Display */
        .central-info {
            position: fixed;
            bottom: 300px;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
            color: var(--accent);
            font-weight: 700;
            text-shadow: 0 0 10px rgba(0, 0, 0, 1);
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 200;
            background: rgba(0, 0, 0, 0.6);
            padding: 12px 24px;
            border-radius: 20px;
            border: 1px solid var(--accent);
            backdrop-filter: blur(5px);
            font-size: 14px;
            max-width: 400px;
            text-align: center;
        }

        .central-info.show {
            opacity: 1;
        }

        /* Horizontal Floating Actions */
        .floating-actions {
            position: fixed;
            display: flex;
            flex-direction: row-reverse !important;
            gap: 16px !important;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%) !important;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }

        .fab .material-icons-round {
            font-size: 24px;
        }

        @media (max-width: 1400px) {
            .model-container {
                width: 100%;
                right: 0;
                top: 84px;
                left: 0;
                height: calc(100vh - 120px);
                padding: 12px;
            }

            .left-sidebar {
                right: 0;
                top: 84px;
                left: 0;
                height: calc(100vh - 120px);
                padding: 12px;
            }

            .left-sidebar {
                top: 84px;
                left: 12px;
                width: 300px;
            }
        }
    </style>

    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon_io/favicon-16x16.png">
    <link rel="manifest" href="/assets/favicon_io/site.webmanifest">
</head>

<body>
    <!-- Unified Header -->
    <header class="simvex-header">
        <div class="logo-section">
            <span class="logo-icon material-icons-round" style="color: var(--accent-primary);">public</span>
            <span class="logo-text">SIMVEX Earth Science</span>
        </div>
        <!-- Collaboration Users -->
        <div id="collaboration-users" style="margin-left: 16px;"></div>
        <nav class="nav-pills header-center">
            <a href="/dashboard.html" class="nav-pill">Dashboard</a>
            <a href="index.html" class="nav-pill">Solar System</a>
            <a href="constellation.html" class="nav-pill">Constellations</a>
            <a href="detailearth.html" class="nav-pill">Atmosphere & Ocean</a>
            <a href="tectonicplates.html" class="nav-pill active">Tectonic Plates</a>
        </nav>
        <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
            <!-- Project Save Button -->
            <button id="project-save-btn" class="save-button" title="Save project">
                <span class="material-icons-round" style="font-size: 18px;">save</span>
                <span id="save-status-text">Save</span>
            </button>
            <!-- Header Controls (Timer, Quiz) -->
            <div id="navbar-controls" style="display: flex; align-items: center;"></div>
        </div>
    </header>
    <div id="ui-layer">
        <!-- Left Sidebar Control Panel -->
        <div class="left-sidebar simvex-panel">
            <div class="panel-body-scroll">
                <div class="panel-section">
                    <div class="panel-title">Tectonic Plate Visualization</div>
                    <h2 id="info-name" style="margin-bottom: 8px;">Crustal Movement</h2>
                    <p id="info-desc" style="font-size: 13px; line-height: 1.6; color: var(--text-secondary);">Earth's
                        tectonic plates are constantly moving. Experience various crustal changes such as earthquakes,
                        volcanoes, and mountain formation with 3D models.</p>
                </div>
                <div class="control-group" style="padding-top: 20px; border-top: 1px solid var(--panel-border);">
                    <label>Plate Movement Simulation</label>
                    <div class="model-grid">
                        <div class="model-card active" onclick="switchModel('subduction')">
                            <div class="model-card-title">Plate Movement</div>
                            <div class="model-card-desc">Process of plate entering the mantle</div>
                        </div>
                        <div class="model-card" onclick="switchModel('collision')">
                            <div class="model-card-title">Plate Collision</div>
                            <div class="model-card-desc">Two plates colliding to form a mountain range</div>
                        </div>
                        <div class="model-card" onclick="switchModel('earthquake')">
                            <div class="model-card-title">Earthquakes and Tsunamis</div>
                            <div class="model-card-desc">Tsunami phenomenon caused by earthquakes</div>
                        </div>
                    </div>
                </div>
                <div class="model-info-panel active" id="info-subduction">
                    <div class="info-title">Plate Movement (Subduction)</div>
                    <div class="info-content">
                        <strong>Concept:</strong>
                        The process where an oceanic plate subducts beneath a continental plate.
                        <strong>Features:</strong>
                        Deep trenches, volcanic activity, periodic earthquakes
                        <strong>Learning Point:</strong>
                        Density differences act as gravity, causing the cold oceanic plate to descend into the mantle.
                    </div>
                </div>
                <div class="model-info-panel" id="info-collision">
                    <div class="info-title">Plate Collision (Orogeny)</div>
                    <div class="info-content">
                        <strong>Concept:</strong>
                        The process where two continental plates collide to form a mountain range.
                        <strong>Features:</strong>
                        High mountains, metamorphic rock formation, seismic zones
                        <strong>Learning Point:</strong>
                        Low-density continental plates do not subduct but deform into folds and reverse faults.
                    </div>
                </div>
                <div class="model-info-panel" id="info-earthquake">
                    <div class="info-title">Earthquakes and Tsunamis</div>
                    <div class="info-content">
                        <strong>Concept:</strong>
                        Earthquakes and sea level changes caused by plate movement.
                        <strong>Features:</strong>
                        Powerful seismic waves, massive waves on the ocean
                        <strong>Learning Point:</strong>
                        Submarine earthquakes mainly occur at plate boundaries and cause large-scale tsunamis.
                    </div>
                </div>
            </div>
        </div>
        <!-- Central Model Viewer -->
        <div class="model-container">
            <div class="model-viewer active" id="model-subduction">
                <div class="sketchfab-embed-wrapper">
                    <iframe title="Moving Tectonic Plates" frameborder="0" allowfullscreen mozallowfullscreen="true"
                        webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking"
                        xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share
                        src="https://sketchfab.com/models/7805590c82a54063aab2f2d691a345b8/embed?autostart=1&camera=0&ui_theme=dark"
                        style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
            <div class="model-viewer" id="model-collision">
                <div class="sketchfab-embed-wrapper">
                    <iframe title="Animated Tectonic Plates Collide Loop" frameborder="0" allowfullscreen
                        mozallowfullscreen="true" webkitallowfullscreen="true"
                        allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking
                        execution-while-out-of-viewport execution-while-not-rendered web-share
                        src="https://sketchfab.com/models/4a052941a17941b39052fa1451c63928/embed?autostart=1&camera=0&ui_hint=0&ui_theme=dark"
                        style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
            <div class="model-viewer" id="model-earthquake">
                <div class="sketchfab-embed-wrapper">
                    <iframe title="Earthquake and Tsunami" frameborder="0" allowfullscreen mozallowfullscreen="true"
                        webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking"
                        xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share
                        src="https://sketchfab.com/models/5325ba12207c4dada68345e52c35ee38/embed?autostart=1&camera=0&ui_hint=0"
                        style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
            <div class="central-info" id="central-info">Click to interact with the model</div>
        </div>
        <!-- Floating Action Buttons -->
        <div class="floating-actions">
            <button class="fab" id="fab-notes" title="Notes">
                <span class="material-icons-round">edit_note</span>
            </button>
            <button class="fab" id="fab-chat" title="AI Assistant">
                <span class="material-icons-round">smart_toy</span>
            </button>
            <button class="fab" id="fab-sticky" title="Sticky Note">
                <span class="material-icons-round">sticky_note_2</span>
            </button>
            <button class="fab" id="fab-draw" title="Drawing Tool">
                <span class="material-icons-round">draw</span>
            </button>
        </div>
        <!-- Chat Popup -->
        <div class="popup-panel" id="chat-popup">
            <div class="popup-header">
                <div class="popup-title">
                    <span class="material-icons-round">smart_toy</span>
                    AI Earth Science Assistant
                </div>
                <button class="popup-close" onclick="closePopup('chat-popup')">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="popup-body" id="ai-panel">
                <div id="chat-messages" style="display: flex; flex-direction: column; gap: 12px;"></div>
            </div>
            <div class="popup-footer">
                <div class="ai-omni-input">
                    <input type="text" id="omni-input" placeholder="Ask about tectonic plates...">
                    <button class="btn-circle" id="omni-send">
                        <span class="material-icons-round">send</span>
                    </button>
                </div>
            </div>
        </div>
        <!-- Notes Popup -->
        <div class="popup-panel" id="notes-popup">
            <div class="popup-header">
                <div class="popup-title">
                    <span class="material-icons-round">edit_note</span>
                    Study Notes
                </div>
                <button class="popup-close" onclick="closePopup('notes-popup')">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="popup-body" id="notes-panel">
                <textarea id="notepad" placeholder="Freely record about tectonic plates..."></textarea>
            </div>
            <div
                style="display: flex; gap: 8px; padding: 12px; border-top: 1px solid var(--border-color); background: rgba(255,255,255,0.02);">
                <button class="btn-circle" id="btn-new-note" title="New Note">
                    <span class="material-icons-round">add</span>
                </button>
                <button class="btn-circle" id="btn-screenshot" title="Attach Screenshot">
                    <span class="material-icons-round">camera_alt</span>
                </button>
                <button class="btn-circle" id="btn-pdf-export" title="Export PDF">
                    <span class="material-icons-round">download</span>
                </button>
                <button class="btn-circle" id="btn-save-note" title="Save"
                    style="flex: 1; width: auto; border-radius: 8px;">
                    <span class="material-icons-round">save</span>
                    <span style="margin-left: 6px;">Save</span>
                </button>
            </div>
        </div>
    </div>
    <!-- Sticky Notes Container -->
    <div id="sticky-notes-container"></div>
    <!-- Custom Eraser Cursor -->
    <div id="custom-cursor"
        style="position: fixed; pointer-events: none; z-index: 999; display: none; transform: translate(-50%, -50%);">
        <div id="cursor-circle"
            style="border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 50%; box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.3);">
        </div>
        <span class="material-icons-round" id="cursor-icon"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 16px; color: rgba(255, 255, 255, 0.9); text-shadow: 0 0 2px rgba(0, 0, 0, 0.5); display: none;">delete</span>
    </div>
    <!-- Drawing Canvas (Global Overlay) -->
    <canvas id="draw-canvas"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 998; display: none;"></canvas>
    <!-- Draw Tool Popup -->
    <div class="popup-panel" id="draw-popup">
        <div class="popup-header">
            <div class="popup-title">
                <span class="material-icons-round">draw</span>
                Drawing Tool
            </div>
            <button class="popup-close" onclick="closePopup('draw-popup')">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        <div class="popup-body" style="padding: 16px;">
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <!-- Tool Selection -->
                <div>
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px;">Tool</label>
                    <div style="display: flex; gap: 8px;">
                        <button class="draw-tool-btn active" data-tool="pen" title="Pen">
                            <span class="material-icons-round">edit</span>
                        </button>
                        <button class="draw-tool-btn" data-tool="eraser" title="Eraser">
                            <span class="material-icons-round">ink_eraser</span>
                        </button>
                        <button class="draw-tool-btn" data-tool="highlighter" title="Highlighter">
                            <span class="material-icons-round">format_paint</span>
                        </button>
                    </div>
                </div>
                <!-- Color Selection -->
                <div>
                    <label
                        style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px;">Color</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="color-btn active" data-color="#8b5cf6" style="background: #8b5cf6;"></button>
                        <button class="color-btn" data-color="#FF6B6B" style="background: #FF6B6B;"></button>
                        <button class="color-btn" data-color="#4ECDC4" style="background: #4ECDC4;"></button>
                        <button class="color-btn" data-color="#45B7D1" style="background: #45B7D1;"></button>
                        <button class="color-btn" data-color="#FFA07A" style="background: #FFA07A;"></button>
                        <button class="color-btn" data-color="#F7DC6F" style="background: #F7DC6F;"></button>
                        <button class="color-btn" data-color="#FFFFFF" style="background: #FFFFFF;"></button>
                    </div>
                </div>
                <!-- Brush Size -->
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px;">
                        Brush Size: <span id="brush-size-value">3</span>px
                    </label>
                    <input type="range" id="brush-size" min="1" max="20" value="3"
                        style="width: 100%; accent-color: var(--accent-primary);">
                </div>
                <!-- Opacity -->
                <div>
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 12px;">
                        Opacity: <span id="opacity-value">100</span>%
                    </label>
                    <input type="range" id="draw-opacity" min="10" max="100" value="100"
                        style="width: 100%; accent-color: var(--accent-primary);">
                </div>
                <!-- Actions -->
                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="btn-circle" id="btn-clear-canvas" title="Clear All"
                        style="width: 100%; border-radius: 8px; background: rgba(220, 38, 38, 0.15); color: #fca5a5; border: 1px solid rgba(220, 38, 38, 0.3); justify-content: center;">
                        <span class="material-icons-round">close</span>
                        <span style="margin-left: 6px;">Clear</span>
                    </button>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button class="btn-circle" id="btn-toggle-visibility" title="Show/Hide Drawings"
                        style="flex: 1; border-radius: 8px; background: rgba(30, 58, 138, 0.4); border: 1px solid rgba(59, 130, 246, 0.3); color: #93c5fd; justify-content: center;">
                        <span class="material-icons-round">visibility</span>
                        <span style="margin-left: 6px;" id="toggle-visibility-text">Hide</span>
                    </button>
                    <button class="btn-circle" id="btn-toggle-draw" title="Enable/Disable Drawing"
                        style="flex: 1; border-radius: 8px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); color: var(--text-secondary); justify-content: center;">
                        <span class="material-icons-round">edit_off</span>
                        <span style="margin-left: 6px;" id="toggle-draw-text">Enable Drawing</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="../js/api.js?v=1.0"></script>
    <script src="../js/workspace-common/workspace-collaboration.js?v=20260210"></script>
    <script src="../js/workspace-common/workspace-chatbot.js"></script>
    <script src="../js/workspace-common/workspace-notes.js"></script>
    <script src="../js/workspace-common/time-tracker.js"></script>
    <script src="../js/workspace-common/study-timer.js"></script>
    <script src="js/study-lab-logic.js?v=2.0"></script>
    <script>
        // Model switching function
        function switchModel(modelType) {
            // Deactivate all cards
            document.querySelectorAll('.model-card').forEach(card => {
                card.classList.remove('active');
            });
            // Hide all viewers
            document.querySelectorAll('.model-viewer').forEach(viewer => {
                viewer.classList.remove('active');
            });
            // Hide all info panels
            document.querySelectorAll('.model-info-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            // Show all loading screens
            document.querySelectorAll('.loading-overlay').forEach(overlay => {
                overlay.classList.remove('hidden');
            });
            // Activate selected model
            document.querySelector(`#model-${modelType}`).classList.add('active');
            document.querySelector(`#info-${modelType}`).classList.add('active');
            // Activate only clicked card
            event.target.closest('.model-card').classList.add('active');
            // Hide loading screen once iframe is loaded
            const viewer = document.querySelector(`#model-${modelType}`);
            const iframe = viewer?.querySelector('iframe');
            const loadingOverlay = document.getElementById(`loading-${modelType}`);
            if (iframe && loadingOverlay) {
                // Detect iframe load event
                const handleLoad = () => {
                    loadingOverlay.classList.add('hidden');
                    iframe.removeEventListener('load', handleLoad);
                };
                // Set timeout (max 5s) in case it's already loaded
                const timeoutId = setTimeout(() => {
                    if (!loadingOverlay.classList.contains('hidden')) {
                        loadingOverlay.classList.add('hidden');
                    }
                }, 5000);
                iframe.addEventListener('load', () => {
                    clearTimeout(timeoutId);
                    handleLoad();
                });
            }
        }
        // Central info display function
        function showCentralInfo(message) {
            const centralInfo = document.getElementById('central-info');
            centralInfo.textContent = message;
            centralInfo.classList.add('show');
            setTimeout(() => {
                centralInfo.classList.remove('show');
            }, 3000);
        }
        // Popup management is handled by study-lab-logic.js
        // Initialization on page load
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id') || urlParams.get('project') || null;
            // WorkspaceChatbot and WorkspaceNotes are handled by study-lab-logic.js
            // Initial loading screen - detect iframe load event
            const initialIframe = document.querySelector('#model-subduction iframe');
            if (initialIframe) {
                const handleInitialLoad = () => {
                    document.querySelectorAll('.loading-overlay').forEach(overlay => {
                        overlay.classList.add('hidden');
                    });
                    initialIframe.removeEventListener('load', handleInitialLoad);
                };
                // Max 6s timeout
                const timeoutId = setTimeout(() => {
                    if (document.querySelector('.loading-overlay:not(.hidden)')) {
                        document.querySelectorAll('.loading-overlay').forEach(overlay => {
                            overlay.classList.add('hidden');
                        });
                    }
                }, 6000);
                initialIframe.addEventListener('load', () => {
                    clearTimeout(timeoutId);
                    handleInitialLoad();
                });
            } else {
                // Hide after 6s if iframe doesn't exist
                setTimeout(() => {
                    document.querySelectorAll('.loading-overlay').forEach(overlay => {
                        overlay.classList.add('hidden');
                    });
                }, 6000);
            }
            // FAB click handlers are handled by study-lab-logic.js
            // Initial guidance message
            showCentralInfo('Welcome to the Tectonic Plate Simulation!');
        });
    </script>
    <script src="../js/api.js?v=1.0"></script>
    <script src="../js/workspace-common/study-timer.js"></script>
    <script src="../js/workspace-common/earthscience-quiz-data.js"></script>
    <script src="../js/workspace-common/workspace-quiz.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            let projectId = params.get('projectId') || params.get('id');
            if (!projectId) {
                console.warn('No projectId in URL - using dev fallback');
                projectId = 'dev-demo-project';
            }
            if (projectId) {
                if (typeof WorkspaceCollaboration !== 'undefined') {
                    window.workspaceCollaboration = new WorkspaceCollaboration({
                        projectId: projectId,
                        containerId: 'collaboration-users'
                    });
                }
                if (typeof StudyTimer !== 'undefined') {
                    new StudyTimer({ projectId: projectId, containerId: 'navbar-controls' });
                }
            }
            // Initialize Quiz
            if (typeof WorkspaceQuiz !== 'undefined') {
                new WorkspaceQuiz({
                    workspace: 'earthscience',
                    containerId: 'navbar-controls'
                });
            }
        });
    </script>
    <script src="/js/pwa.js"></script>
</body>

</html>